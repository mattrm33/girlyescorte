<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mini Réseau Social</title>
  <style>
    body { font-family: Arial; background: #f2f2f2; margin:0; padding:20px; }
    .container { max-width:600px; margin:auto; background:white; padding:20px; border-radius:10px; }
    .hidden { display:none; }
    .chat { border:1px solid #ccc; height:200px; overflow-y:scroll; padding:10px; margin-bottom:10px; }
    .message { margin:5px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Mini Réseau Social</h1>

    <div id="auth">
      <h2>Inscription</h2>
      <input id="signupPseudo" placeholder="Pseudo"><br>
      <input id="signupEmail" placeholder="Email"><br>
      <input id="signupPass" type="password" placeholder="Mot de passe"><br>
      <button onclick="signup()">S'inscrire</button>

      <h2>Connexion</h2>
      <input id="loginEmail" placeholder="Email"><br>
      <input id="loginPass" type="password" placeholder="Mot de passe"><br>
      <button onclick="login()">Se connecter</button>
    </div>

    <div id="app" class="hidden">
      <h2 id="welcome"></h2>
      <p>Votre code ami : <span id="friendCode"></span></p>
      <input id="friendInput" placeholder="Code ami">
      <button onclick="addFriend()">Ajouter un ami</button>
      <p>Vos amis : <span id="friendsList"></span></p>

      <h3>Chat</h3>
      <div class="chat" id="chatBox"></div>
      <input id="chatInput" placeholder="Message...">
      <button onclick="sendMessage()">Envoyer</button>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    const API = "http://localhost:3000";
    let token = null;
    let socket = null;

    async function signup() {
      let pseudo = document.getElementById("signupPseudo").value;
      let email = document.getElementById("signupEmail").value;
      let password = document.getElementById("signupPass").value;

      let res = await fetch(API+"/signup", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ pseudo, email, password })
      });
      let data = await res.json();
      alert(data.success ? "Inscription réussie" : data.error);
    }

    async function login() {
      let email = document.getElementById("loginEmail").value;
      let password = document.getElementById("loginPass").value;

      let res = await fetch(API+"/login", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ email, password })
      });
      let data = await res.json();
      if (data.success) {
        token = data.token;
        document.getElementById("auth").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        document.getElementById("welcome").innerText = "Bienvenue " + data.user.pseudo;
        document.getElementById("friendCode").innerText = data.user.code;
        loadSocket();
      } else {
        alert(data.error);
      }
    }

    async function addFriend() {
      let code = document.getElementById("friendInput").value;
      let res = await fetch(API+"/add-friend", {
        method:"POST", headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ token, code })
      });
      let data = await res.json();
      if (data.success) {
        document.getElementById("friendsList").innerText = data.friends.join(", ");
      } else {
        alert(data.error);
      }
    }

    function loadSocket() {
      socket = io(API);
      socket.on("receiveMessage", (msg) => {
        let box = document.getElementById("chatBox");
        box.innerHTML += `<div class="message">${msg}</div>`;
        box.scrollTop = box.scrollHeight;
      });
    }

    function sendMessage() {
      let msg = document.getElementById("chatInput").value;
      socket.emit("sendMessage", msg);
      document.getElementById("chatInput").value = "";
    }
  </script>
</body>
</html>
